<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Automated deployer of OpenShift cluster and IBM Cloud Paks"><meta name=author content=Author><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.5.3"><title>Unit testing - Playground</title><link rel=stylesheet href=../assets/stylesheets/main.7a952b86.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#unit-testing-in-typescript class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Playground class="md-header__button md-logo" aria-label=Playground data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Playground </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Unit testing </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/IBM/Developer-Playground title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> Developer-Playground </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Playground class="md-nav__button md-logo" aria-label=Playground data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Playground </label> <div class=md-nav__source> <a href=https://github.com/IBM/Developer-Playground title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> Developer-Playground </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../architecture/ class=md-nav__link> Architecture </a> </li> <li class=md-nav__item> <a href=../demo-manager/ class=md-nav__link> Demo manager </a> </li> <li class=md-nav__item> <a href=../code-server/ class=md-nav__link> Code Server </a> </li> <li class=md-nav__item> <a href=../assethub/ class=md-nav__link> Asset Hub </a> </li> <li class=md-nav__item> <a href=../db/ class=md-nav__link> DB schema </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Unit testing <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Unit testing </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#unit-testing-in-typescript class=md-nav__link> Unit Testing in TypeScript </a> <nav class=md-nav aria-label="Unit Testing in TypeScript"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ts-node class=md-nav__link> ts-node </a> </li> <li class=md-nav__item> <a href=#mocha class=md-nav__link> Mocha </a> </li> <li class=md-nav__item> <a href=#chai class=md-nav__link> Chai </a> <nav class=md-nav aria-label=Chai> <ul class=md-nav__list> <li class=md-nav__item> <a href=#should class=md-nav__link> Should </a> </li> <li class=md-nav__item> <a href=#expect class=md-nav__link> Expect </a> </li> <li class=md-nav__item> <a href=#assert class=md-nav__link> Assert </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nock class=md-nav__link> Nock </a> </li> <li class=md-nav__item> <a href=#sinon class=md-nav__link> Sinon </a> </li> <li class=md-nav__item> <a href=#nycistanbul class=md-nav__link> Nyc/Istanbul </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#set-up-your-project class=md-nav__link> Set up your project </a> </li> <li class=md-nav__item> <a href=#create-a-simple-test class=md-nav__link> Create a Simple Test </a> </li> <li class=md-nav__item> <a href=#ignoring-code-in-coverage-reports class=md-nav__link> Ignoring Code in Coverage Reports </a> </li> <li class=md-nav__item> <a href=#create-a-mock-for-external-dependencies-using-nock class=md-nav__link> Create a mock for external dependencies using Nock </a> </li> <li class=md-nav__item> <a href=#create-a-stub-for-external-dependencies-using-sinon class=md-nav__link> Create a stub for external dependencies using Sinon </a> </li> <li class=md-nav__item> <a href=#code-coverage-reports class=md-nav__link> Code Coverage reports </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#unit-testing-in-typescript class=md-nav__link> Unit Testing in TypeScript </a> <nav class=md-nav aria-label="Unit Testing in TypeScript"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ts-node class=md-nav__link> ts-node </a> </li> <li class=md-nav__item> <a href=#mocha class=md-nav__link> Mocha </a> </li> <li class=md-nav__item> <a href=#chai class=md-nav__link> Chai </a> <nav class=md-nav aria-label=Chai> <ul class=md-nav__list> <li class=md-nav__item> <a href=#should class=md-nav__link> Should </a> </li> <li class=md-nav__item> <a href=#expect class=md-nav__link> Expect </a> </li> <li class=md-nav__item> <a href=#assert class=md-nav__link> Assert </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nock class=md-nav__link> Nock </a> </li> <li class=md-nav__item> <a href=#sinon class=md-nav__link> Sinon </a> </li> <li class=md-nav__item> <a href=#nycistanbul class=md-nav__link> Nyc/Istanbul </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#set-up-your-project class=md-nav__link> Set up your project </a> </li> <li class=md-nav__item> <a href=#create-a-simple-test class=md-nav__link> Create a Simple Test </a> </li> <li class=md-nav__item> <a href=#ignoring-code-in-coverage-reports class=md-nav__link> Ignoring Code in Coverage Reports </a> </li> <li class=md-nav__item> <a href=#create-a-mock-for-external-dependencies-using-nock class=md-nav__link> Create a mock for external dependencies using Nock </a> </li> <li class=md-nav__item> <a href=#create-a-stub-for-external-dependencies-using-sinon class=md-nav__link> Create a stub for external dependencies using Sinon </a> </li> <li class=md-nav__item> <a href=#code-coverage-reports class=md-nav__link> Code Coverage reports </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/IBM/Developer-Playground/edit/development/docs/unit-testing.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Unit testing</h1> <h2 id=unit-testing-in-typescript>Unit Testing in TypeScript<a class=headerlink href=#unit-testing-in-typescript title="Permanent link">🔗</a></h2> <p>This guide will show you how to setup a TypeScript project to set up unit testing.</p> <h3 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">🔗</a></h3> <p>There are a variety of tools that can be used for Unit Testing in TypeScript or Javascript. These are the ones used in this example.</p> <h4 id=ts-node>ts-node<a class=headerlink href=#ts-node title="Permanent link">🔗</a></h4> <p><a href=https://typestrong.org/ts-node/docs/ >ts-node</a> is a JIT compiler that allows your test code to directly execute the TypeScript which allows the code coverage to be tracked at the TypeScript level instead of the complile Javascript</p> <h4 id=mocha>Mocha<a class=headerlink href=#mocha title="Permanent link">🔗</a></h4> <p><a href=https://mochajs.org/ >Mocha</a> is a feature-rich test framework which will execute the tests.</p> <h4 id=chai>Chai<a class=headerlink href=#chai title="Permanent link">🔗</a></h4> <p><a href=https://www.chaijs.com/ >Chai</a> is an assertion library which iss BDD or TDD style asserts. It allows three classes of assertions where the same assertions are shown using it below.</p> <h5 id=should>Should<a class=headerlink href=#should title="Permanent link">🔗</a></h5> <div class=codehilite><pre><span></span><code><span class=nx>foo</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=err>‘</span><span class=nx>bar</span><span class=err>’</span><span class=p>);</span>
<span class=nx>foo</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mf>5</span><span class=p>);</span>
</code></pre></div> <h5 id=expect>Expect<a class=headerlink href=#expect title="Permanent link">🔗</a></h5> <div class=codehilite><pre><span></span><code><span class=nx>expect</span><span class=p>(</span><span class=nx>foo</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=err>‘</span><span class=nx>bar</span><span class=err>’</span><span class=p>);</span>
<span class=nx>expect</span><span class=p>(</span><span class=nx>foo</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mf>3</span><span class=p>);</span>
</code></pre></div> <h5 id=assert>Assert<a class=headerlink href=#assert title="Permanent link">🔗</a></h5> <div class=codehilite><pre><span></span><code><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>foo</span><span class=p>,</span><span class=w> </span><span class=err>‘</span><span class=nx>bar</span><span class=err>’</span><span class=p>);</span>
<span class=nx>assert</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>foo</span><span class=p>,</span><span class=w> </span><span class=mf>3</span><span class=p>);</span>
</code></pre></div> <h4 id=nock>Nock<a class=headerlink href=#nock title="Permanent link">🔗</a></h4> <p><a href=https://github.com/nock/nock>Nock</a> is a mocking framework that allows you to mock HTTP requests to calls to an external service. You can mock the response to a known response allowing the testing to focus on your code. </p> <h4 id=sinon>Sinon<a class=headerlink href=#sinon title="Permanent link">🔗</a></h4> <p><a href=https://sinonjs.org/ >Sinon</a> is a another mocking framework that allows you to create spies, stubs and mocks to provide a known response when testing your code. </p> <h4 id=nycistanbul>Nyc/Istanbul<a class=headerlink href=#nycistanbul title="Permanent link">🔗</a></h4> <p><a href=https://istanbul.js.org/ >Istanbul</a> is a test coverage tool that will analyze and report on the test coverage provided by your test cases.<br> <a href=https://github.com/istanbuljs/nyc>Nyc</a> is the command line client that works with Istanbul</p> <h3 id=set-up-your-project>Set up your project<a class=headerlink href=#set-up-your-project title="Permanent link">🔗</a></h3> <p>To set up your project, run the following to install the dependencies and update package.json</p> <div class=codehilite><pre><span></span><code>$ npm install mocha chai ts-node nyc @types/mocha
</code></pre></div> <p>If you have not done it already, create a test folder at the project root for the testing files.</p> <p>In that folder create a file <strong><em>test/tsconfig.json</em></strong> to configure TypeScript for testing containing the following. The will set configuration for things executed from the test folder to use ts-node to transpile instead of compile and execute as Javascript.</p> <div class=codehilite><pre><span></span><code><span class=p>{</span>
<span class=w>    </span><span class=s2>&quot;extends&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;../tsconfig.json&quot;</span><span class=p>,</span>
<span class=w>    </span><span class=s2>&quot;ts-node&quot;</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=s2>&quot;transpileOnly&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;files&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=s2>&quot;compilerOptions&quot;</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=s2>&quot;baseUrl&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;./&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;module&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;commonjs&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;experimentalDecorators&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;strictPropertyInitialization&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;isolatedModules&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;strict&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;noImplicitAny&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;typeRoots&quot;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>        </span><span class=s2>&quot;../node_modules/@types&quot;</span>
<span class=w>      </span><span class=p>]</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=s2>&quot;exclude&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;../node_modules&quot;</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>    </span><span class=s2>&quot;include&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;./**/*.ts&quot;</span>
<span class=w>    </span><span class=p>]</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div> <p>We are also going to use dotenv so we can move configuration that might be in a ConfigMap to a .env file. Create a file <strong><em>test/.env</em></strong> to contain the environment values you will used when executing a test in a variable=value format. Note these do not have to be exactly like the ones on a test or production environment but will make to what is expected with tests</p> <div class=codehilite><pre><span></span><code><span class=nx>testEndpoint</span><span class=o>=</span><span class=nx>https</span><span class=o>:</span><span class=c1>//localhost/test</span>
<span class=nx>testApiKeyId</span><span class=o>=</span><span class=nx>testApiKeyIdValue</span><span class=w>  </span>
</code></pre></div> <p>Now to turn on this ts-node and dotenv configuration, create a file <strong><em>./.mocharc.json</em></strong> in the project root and add the following.</p> <div class=codehilite><pre><span></span><code><span class=p>{</span>
<span class=w>    </span><span class=s2>&quot;require&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;./register.js&quot;</span><span class=p>,</span>
<span class=w>    </span><span class=s2>&quot;reporter&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;dot&quot;</span>
<span class=p>}</span>
</code></pre></div> <p>Next, create a file <strong><em>./register.js</em></strong> at the project root and add the following. This will use our env file with dotenv and call our ts-node configuration when we are testing.</p> <div class=codehilite><pre><span></span><code><span class=cm>/**</span>
<span class=cm> * Overrides the tsconfig used for the app.</span>
<span class=cm> * In the test environment we need some tweaks.</span>
<span class=cm> */</span>

<span class=c1>// Read .env for access to process.env</span>
<span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>dotenv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;dotenv&#39;</span><span class=p>)</span>
<span class=w> </span><span class=nx>dotenv</span><span class=p>.</span><span class=nx>config</span><span class=p>({</span><span class=nx>path</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./test/.env&#39;</span><span class=p>});</span>

<span class=w> </span><span class=c1>// Enable tsNode</span>
<span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>tsNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;ts-node&#39;</span><span class=p>);</span>
<span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>testTSConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./test/tsconfig.json&#39;</span><span class=p>);</span>
<span class=w> </span>
<span class=w> </span>
<span class=w> </span><span class=nx>tsNode</span><span class=p>.</span><span class=nx>register</span><span class=p>({</span>
<span class=w>   </span><span class=nx>project</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./test/tsconfig.json&#39;</span>
<span class=w> </span><span class=p>});</span>
</code></pre></div> <p>To set up the code coverage configuration, add the following to the file <strong><em>./.nyrc.json</em></strong> in the project root</p> <div class=codehilite><pre><span></span><code><span class=p>{</span>
<span class=w>    </span><span class=s2>&quot;extends&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;@istanbuljs/nyc-config-typescript&quot;</span><span class=p>,</span>
<span class=w>    </span><span class=s2>&quot;all&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>    </span><span class=s2>&quot;check-coverage&quot;</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>    </span><span class=s2>&quot;include&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;src/**/*.ts&quot;</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>    </span><span class=s2>&quot;exclude&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;node_modules/&quot;</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>    </span><span class=s2>&quot;extension&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;.ts&quot;</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>    </span><span class=s2>&quot;reporter&quot;</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=s2>&quot;text-summary&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=s2>&quot;html&quot;</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>    </span><span class=s2>&quot;report-dir&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;./coverage&quot;</span>
<span class=p>}</span>
</code></pre></div> <p>You will want to be sure all of the source code for which coverage should be measured is in the include array.</p> <p>And be sure that any code that should be excluded (in this case node_modules) is in the exclude array.</p> <p>Add the following to the scripts array in <strong>./<em>package.json</em></strong> in the project root to provide a command to test <div class=codehilite><pre><span></span><code><span class=s2>&quot;test&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;nyc --all --reporter=lcov --reporter=text --reporter=text-summary ./node_modules/.bin/_mocha --reporter=spec &#39;test/**/*.test.ts&#39;&quot;</span><span class=p>,</span>
<span class=s2>&quot;posttest&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;nyc report --reporter=lcov&quot;</span>
</code></pre></div></p> <h3 id=create-a-simple-test>Create a Simple Test<a class=headerlink href=#create-a-simple-test title="Permanent link">🔗</a></h3> <p>Now it is time to create test cases.</p> <p>There are two styles that can be used for test case creation.</p> <p><strong>Testdeck</strong> – This is a wrapper for Mocha which allows more object-oriented behaviour. But there is not a lot of documentation for it so use with caution. The documentation for <a href=https://testdeck.org/ >testdeck</a> can be found here. This is used in <a href=https://github.ibm.com/ibm-api-marketplace/playground-workspaces/blob/master/test/pool.calculator.test.ts>https://github.ibm.com/ibm-api-marketplace/playground-workspaces/blob/master/test/pool.calculator.test.ts</a>. </p> <p>With this you have a test class (with an <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/suite title="GitHub User: suite">@suite</a> assertion) with test functions (with an <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/test title="GitHub User: test">@test</a> assertion). There are special functions, like before() which is executed before each test that can be used.</p> <p><strong>Mocha</strong> – This is more standard mocha way of testing and will be explored more here. The documentation can be found <a href=https://mochajs.org/#getting-started>here</a></p> <p>For our first example we will test a class that reads environment information and provides information about it.</p> <p>First, update <strong><em>test/.env</em></strong> with the following lines for the config that we will test. Note how we have simplified the data to be generic for our test case.</p> <div class=codehilite><pre><span></span><code><span class=nx>devfiles</span><span class=o>=</span><span class=nx>devfile1</span><span class=p>,</span><span class=nx>devfile2</span>
<span class=nx>devfile_devfile1</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;devfile&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;actual-devfile1&quot;</span><span class=p>,</span><span class=s2>&quot;weight&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;5&quot;</span><span class=p>,</span><span class=s2>&quot;default&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;true&quot;</span><span class=p>}</span>
<span class=nx>devfile_devfile2</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;devfile&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;actual-devfile2&quot;</span><span class=p>,</span><span class=s2>&quot;weight&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;2&quot;</span><span class=p>}</span>
</code></pre></div> <p>Create a file for the test case. It is probably best to name it related to the file that it is testing. </p> <p>Create <strong><em>test/devfile.controller.test.ts</em></strong> and add the describe function to it</p> <div class=codehilite><pre><span></span><code><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>assert</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>should</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;chai&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>utils</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;mocha&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=nx>nock</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;nock&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>DevfileController</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../src/controller/devfile.controller&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>DevfileConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../src/model/devfile.config&#39;</span><span class=p>;</span>
<span class=kd>const</span><span class=w> </span><span class=nx>yaml</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;js-yaml&#39;</span><span class=p>);</span>

<span class=kd>let</span><span class=w> </span><span class=nx>devfileController</span><span class=o>:</span><span class=w> </span><span class=nx>DevfileController</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>DevfileController</span><span class=p>.</span><span class=nx>getInstance</span><span class=p>();</span>

<span class=nx>describe</span><span class=p>(</span><span class=s2>&quot;Testing DevfileController&quot;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>

<span class=p>});</span>
</code></pre></div> <p>Now let’s add a test inside it.</p> <p>Add the following test. The function “it” is taken from BDD and literally means it with the parameter describing the test.</p> <p>This test verifies one of the environment variables and the isDefault property that is set with it.</p> <div class=codehilite><pre><span></span><code><span class=nx>describe</span><span class=p>(</span><span class=s2>&quot;Testing DevfileController&quot;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>

<span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests getDevfile()</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;getDevfile&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=nx>DevfileConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>devfileController</span><span class=p>.</span><span class=nx>getDevFileConfig</span><span class=p>(</span><span class=s2>&quot;devfile_devfile1&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>devfilename</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;actual-devfile1&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>isDefault</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span>
<span class=w>  </span><span class=p>});</span>

<span class=p>});</span>
</code></pre></div> <p>Save this and now you can test it.</p> <p>To run all of the test you can run <strong><em>npm test</em></strong> which will run the test but also show the test coverage on the files testing including the lines not tested. We will show more on that later.</p> <div class=codehilite><pre><span></span><code>$ npm test

&gt; playground-monitoring@0.0.0 test
&gt; nyc --all --reporter=lcov --reporter=text --reporter=text-summary ./node_modules/.bin/_mocha --reporter=spec &#39;test/**/*.test.ts&#39;



  Testing DevfileController
    ✔ getDevfile


  1 passing (4ms)

--------------------------------------|---------|----------|---------|---------|-------------------
File                                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
--------------------------------------|---------|----------|---------|---------|-------------------
All files                             |   54.63 |    47.36 |    25.8 |   54.63 |                   
 playground-workspaces                |     100 |      100 |     100 |     100 |                   
  register.js                         |     100 |      100 |     100 |     100 |                   
 playground-workspaces/src/controller |   69.04 |       50 |   27.27 |   69.04 |                   
  devfile.controller.ts               |   69.04 |       50 |   27.27 |   69.04 | 58-92             
 playground-workspaces/src/model      |   72.72 |       40 |      50 |   72.72 |                   
  devfile.config.ts                   |   72.72 |       40 |      50 |   72.72 | 19-22             
 playground-workspaces/src/service    |   63.63 |      100 |      50 |   63.63 |                   
  git.service.ts                      |   63.63 |      100 |      50 |   63.63 | 19-25             
 playground-workspaces/src/utils      |   14.28 |      100 |   14.28 |   14.28 |                   
  https.ts                            |   14.28 |      100 |   14.28 |   14.28 | 15-89             
--------------------------------------|---------|----------|---------|---------|-------------------

=============================== Coverage summary ===============================
Statements   : 54.63% ( 53/97 )
Branches     : 47.36% ( 9/19 )
Functions    : 25.8% ( 8/31 )
Lines        : 54.63% ( 53/97 )
================================================================================

&gt; playground-monitoring@0.0.0 posttest
&gt; nyc report --reporter=lcov
</code></pre></div> <p>Or to run a specific test, you can run. The option –reporter=spec shows more details on each test “it” run. <div class=codehilite><pre><span></span><code>$ ./node_modules/.bin/_mocha  --reporter=spec test/devfile.controller.test.ts

  Testing DevfileController
    ✔ getDevfile


  1 passing (23ms)
</code></pre></div> You can now add more tests</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests getDefaultDevfile()</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;getDefaultDevfile&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>devfileController</span><span class=p>.</span><span class=nx>getDefaultDevFile</span><span class=p>();</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;devfile1&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=p>});</span>
<span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests getWeight()</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;getWeight&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>devfileController</span><span class=p>.</span><span class=nx>getWeight</span><span class=p>(</span><span class=s2>&quot;devfile_devfile1&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=mf>5</span><span class=p>);</span>
<span class=w>  </span><span class=p>});</span>

<span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests getWeightTotal()</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;getWeightTotal&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>devfileController</span><span class=p>.</span><span class=nx>getWeightTotal</span><span class=p>();</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=mf>7</span><span class=p>);</span>
<span class=w>  </span><span class=p>});</span>
</code></pre></div> <h3 id=ignoring-code-in-coverage-reports>Ignoring Code in Coverage Reports<a class=headerlink href=#ignoring-code-in-coverage-reports title="Permanent link">🔗</a></h3> <p>In some cases, it does not make sense to unit test some lines of code, though this should be used cautiously. In this example, there is a function that is there if we want to log more information but the developer decides it does not need to be tested. By adding this “special” comment </p> <p>/* istanbul ignore next */</p> <p>nyc will ignore these line in code coverage</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=kr>public</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>logDevFiles</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=cm>/* istanbul ignore next */</span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>devfiles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>value</span><span class=o>:</span><span class=w> </span><span class=nx>DevfileConfig</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>((</span><span class=k>await</span><span class=w> </span><span class=nx>value</span><span class=p>.</span><span class=nx>getDevFile</span><span class=p>()).</span><span class=nx>toString</span><span class=p>());</span>
<span class=w>      </span><span class=p>});</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div> <h3 id=create-a-mock-for-external-dependencies-using-nock>Create a mock for external dependencies using Nock<a class=headerlink href=#create-a-mock-for-external-dependencies-using-nock title="Permanent link">🔗</a></h3> <p>One of the functions we want to test eventually makes an external API call. In unit testing you do not want to call anything external for a variety of reasons including • Is the service up? • Extra testing load on the service • What if the data changes</p> <p>The following will show you how to mock (using nock) the results of the API call.</p> <p>Here is the function we want to test</p> <div class=codehilite><pre><span></span><code><span class=w>    </span><span class=kr>public</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>overrideMetaName</span><span class=p>(</span><span class=nx>devfile</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>,</span><span class=w> </span><span class=nx>metaname</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>)</span><span class=w> </span><span class=o>:</span>
<span class=w>  </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>WorkspaceDevfile</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=nx>devFileStr</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>gitService</span><span class=p>.</span><span class=nx>getDevFileByName</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>devfiles</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>devfile</span><span class=p>).</span><span class=nx>devfilename</span><span class=p>);</span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=nx>devFileObj</span><span class=w> </span><span class=o>:</span><span class=nx>any</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>yaml</span><span class=p>.</span><span class=nx>safeLoad</span><span class=p>(</span><span class=nx>devFileStr</span><span class=p>);</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;object&quot;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;string&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=nx>devFileObj</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>metaname</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=cm>/* istanbul ignore next */</span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&quot;Parsing error&quot;</span><span class=p>);</span>
<span class=w>        </span><span class=p>}</span>
<span class=w>        </span><span class=c1>//return devFileObj;</span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>devFileObj</span><span class=p>));</span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div> <p>But, <em>this.gitService.getDevFileByName(string)</em> is an external call.</p> <p>First, we create a file with the response we want back from that call. Often (and maybe normally), the response is json and a .json file is appropriate, but in this case it is a yaml file. Create the following file at <strong><em>test/mock-responses/gitdevfile.yaml</em></strong>. Note we are going to put are going to use <strong><em>test/mock-responses</em></strong> for these responses</p> <div class=codehilite><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class=nt>attributes</span><span class=p>:</span>
<span class=w>  </span><span class=nt>persistVolumes</span><span class=p>:</span><span class=w> </span><span class=s>&#39;false&#39;</span>
</code></pre></div> <p>Now let’s dig into the test that will use it</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests overrideMetaName()</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;overrideMetaName&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>gitURL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;https://raw.githubusercontent.com/IBM/Developer-Playground/master/devfiles&quot;</span>
<span class=w>    </span><span class=nx>nock</span><span class=p>(</span><span class=nx>gitURL</span><span class=p>)</span>
<span class=w>      </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;/actual-devfile1.yaml&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=p>.</span><span class=nx>replyWithFile</span><span class=p>(</span><span class=mf>200</span><span class=p>,</span><span class=w> </span><span class=nx>__dirname</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;/mock-responses/gitdevfile.yaml&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>devfileController</span><span class=p>.</span><span class=nx>overrideMetaName</span><span class=p>(</span><span class=s2>&quot;devfile_devfile1&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;newmetaname&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>metaname</span><span class=p>;</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;object&quot;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=ow>typeof</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;string&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nx>metaname</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>metaname</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;newmetaname&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=p>});</span>
</code></pre></div> <p>The API call that we want to mock is a GET request to <a href=https://raw.githubusercontent.com/IBM/Developer-Playground/master/devfiles/actual-devfile1.yaml>https://raw.githubusercontent.com/IBM/Developer-Playground/master/devfiles/actual-devfile1.yaml</a></p> <p>And we want the mocked file above to be the response.</p> <p>This block of code creates a mock response so that when the gitURL is called with the GET request for <em>/actual-devfile1.yaml</em>, that a 200 response will sent along with the content in <strong><em>/mock-responses/gitdevfile.yaml</em></strong>.</p> <p><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=nx>nock</span><span class=p>(</span><span class=nx>gitURL</span><span class=p>)</span>
<span class=w>    </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;/actual-devfile1.yaml&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=p>.</span><span class=nx>replyWithFile</span><span class=p>(</span><span class=mf>200</span><span class=p>,</span><span class=w> </span><span class=nx>__dirname</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;/mock-responses/gitdevfile.yaml&#39;</span><span class=p>);</span>
</code></pre></div> In this function the <em>metadata.name</em> value (<em>sample-app</em> in the mock response) is overridden with a variable passed to the function, but the mocking does allow us to test the parsing of the response data</p> <p>Note that nock will ONLY override the request the first time this request is made. Another call to it will actually call the external service. In this case we defined it in the test case because we were only calling it once</p> <p>If we have a repeated call that we always mock the response we can include a <strong>beforeEach</strong> function in the test.</p> <p>Here is an example where an authentication token is mocked for repeated authorization calls in the test that would follow.</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=nx>beforeEach</span><span class=p>(</span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=c1>// Do this everytime since the same result is needed</span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>mockResponse_keycloakToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./mock-responses/keycloak-token.json&#39;</span><span class=p>);</span>
<span class=w>      </span><span class=nx>nock</span><span class=p>(</span><span class=nx>keyCloakUrl</span><span class=p>)</span>
<span class=w>          </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=nx>userTokenEndpoint</span><span class=p>)</span>
<span class=w>          </span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span><span class=mf>200</span><span class=p>,</span><span class=w> </span><span class=nx>mockResponse_keycloakToken</span><span class=p>);</span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>timeout</span><span class=p>(</span><span class=mf>10000</span><span class=p>);</span>
<span class=w>  </span><span class=p>})</span>
</code></pre></div> <h3 id=create-a-stub-for-external-dependencies-using-sinon>Create a stub for external dependencies using Sinon<a class=headerlink href=#create-a-stub-for-external-dependencies-using-sinon title="Permanent link">🔗</a></h3> <p>Sometimes you cannot mock at the HTTP level. A good example is the SDK used to interact with Cloud Object Storage. The communications with Object Storage is encapsulated in the SDK and not easily mocked. Sinon allows you to create a stub for a function call so that you can intercept it before the SDK and return a mocked response.</p> <p>In this case we want to mock the response to this function in our code in the CoS class</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=kr>public</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>readItem</span><span class=p>(</span><span class=nx>bucketName</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>,</span><span class=w> </span><span class=nx>itemName</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>)</span>
</code></pre></div> <p>This code sets up the "stub" to respond whenever that function is called directly or indirectly in a test. Note that the mocked response returned will be the contents of <em><strong>./mock-responses/cosdevfile.yaml</strong></em>. In this case the item in Object Storage is a string that just happens to be yaml, but it is treated as a string and could be JSON or any other string.</p> <p>Note <code>.stub(&lt;object&gt;,&lt;function&gt;</code> which connects the stub to the function. And the function defined in <code>.callsFake(&lt;function() {});&gt;)</code> provides what will be done in the stub</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>cos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>CoS</span><span class=p>.</span><span class=nx>getInstance</span><span class=p>();</span>
<span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>sandbox</span><span class=p>;</span>

<span class=w>  </span><span class=nx>before</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=cm>/* Use signon fake instead of nock to mock the readItem function as the COS SDK makes </span>
<span class=cm>    *  multiple calls which make it very to use nock.  This overrides any call to the readItem method.</span>
<span class=cm>    */</span>
<span class=w>    </span><span class=nx>sandbox</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>sinon</span><span class=p>.</span><span class=nx>createSandbox</span><span class=p>();</span>
<span class=w>    </span><span class=nx>sandbox</span>
<span class=w>      </span><span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>cos</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;readItem&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=p>.</span><span class=nx>callsFake</span><span class=p>(</span><span class=kd>function</span><span class=w>  </span><span class=nx>fakeReadItem</span><span class=w> </span><span class=p>(</span><span class=nx>bucketName</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>,</span><span class=w> </span><span class=nx>itemName</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>__dirname</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;/mock-responses/cosdevfile.yaml&#39;</span><span class=p>);</span>
<span class=w>      </span><span class=p>});</span>

<span class=w>  </span><span class=p>});</span>
</code></pre></div> <p>In our test, it is the call to <code>devfileService.getDevFile();</code> that ultimately calls the stub and we can make assertions based on known values.</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Tests DevFileService() with cos</span>
<span class=cm>  */</span>
<span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;DevFileService() with cos&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>


<span class=w>    </span><span class=c1>// Using true to force a new instance to clear anything set in previous test.</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>devfileService</span><span class=o>:</span><span class=w> </span><span class=nx>DevfileService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>DevfileService</span><span class=p>.</span><span class=nx>getInstance</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>devfileService</span><span class=p>.</span><span class=nx>getServiceProvider</span><span class=p>(),</span><span class=s2>&quot;cos&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>devFileObj</span><span class=w> </span><span class=o>:</span><span class=nx>any</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>devfileService</span><span class=p>.</span><span class=nx>getDevFile</span><span class=p>();</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=p>,</span><span class=s2>&quot;object&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span><span class=s1>&#39;string&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;object&quot;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=ow>typeof</span><span class=w> </span><span class=nx>devFileObj</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;string&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>devFileObj</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span><span class=s2>&quot;sample-app-cos&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>});</span>
</code></pre></div> <p>At the end of the test, you must use a restore to cancel out the stub</p> <div class=codehilite><pre><span></span><code><span class=w>  </span><span class=nx>after</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=c1>// Restore sinon fake</span>
<span class=w>    </span><span class=nx>sandbox</span><span class=p>.</span><span class=nx>restore</span><span class=p>();</span>
<span class=w>  </span><span class=p>});</span>
</code></pre></div> <h3 id=code-coverage-reports>Code Coverage reports<a class=headerlink href=#code-coverage-reports title="Permanent link">🔗</a></h3> <p>Remember that we defined the npm test script to run nyc in <strong><em>./package.json</em></strong></p> <p>And we defined the options in <strong><em>./.nyrc.json</em></strong></p> <p>With this when you run npm test, it will update the following directories below.</p> <p><strong><em>./.nyc-output</em></strong> - process and coverage information</p> <p><strong><em>./coverage</em></strong> – location defined in the options for for coverage report which you be viewed in a browser with file <strong><em>./coverage/index.html</em></strong> In this we can drill down to see the coverage we have on the file we were testing</p> <p>Also note that you should add these directories to .gitignore as you do not want to commit these coverages. Instead anything that uses the coverage in the DevOps process should run the test each time you want to evaluate. </p> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../db/ class="md-footer__link md-footer__link--prev" aria-label="Previous: DB schema" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> DB schema </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.37e9125f.min.js></script> <script src=../js/open_in_new_tab.js></script> </body> </html>